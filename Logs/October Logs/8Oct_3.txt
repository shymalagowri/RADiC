  0%|          | 0/500 [00:00<?, ?it/s]  0%|          | 0/500 [00:01<?, ?it/s, accuracy=1]  0%|          | 1/500 [00:01<11:32,  1.39s/it, accuracy=1]  0%|          | 1/500 [00:01<11:32,  1.39s/it, accuracy=1]  0%|          | 1/500 [00:01<11:32,  1.39s/it, accuracy=0.917]  0%|          | 1/500 [00:01<11:32,  1.39s/it, accuracy=0.875]  0%|          | 1/500 [00:01<11:32,  1.39s/it, accuracy=0.9]    1%|          | 5/500 [00:01<01:54,  4.32it/s, accuracy=0.9]  1%|          | 5/500 [00:01<01:54,  4.32it/s, accuracy=0.875]  1%|          | 5/500 [00:01<01:54,  4.32it/s, accuracy=0.857]  1%|          | 5/500 [00:01<01:54,  4.32it/s, accuracy=0.875]  1%|          | 5/500 [00:01<01:54,  4.32it/s, accuracy=0.861]  2%|▏         | 9/500 [00:01<00:58,  8.33it/s, accuracy=0.861]  2%|▏         | 9/500 [00:01<00:58,  8.33it/s, accuracy=0.875]  2%|▏         | 9/500 [00:01<00:58,  8.33it/s, accuracy=0.886]  2%|▏         | 9/500 [00:01<00:58,  8.33it/s, accuracy=0.875]  2%|▏         | 9/500 [00:01<00:58,  8.33it/s, accuracy=0.865]  3%|▎         | 13/500 [00:01<00:38, 12.52it/s, accuracy=0.865]  3%|▎         | 13/500 [00:01<00:38, 12.52it/s, accuracy=0.857]  3%|▎         | 13/500 [00:01<00:38, 12.52it/s, accuracy=0.817]/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/nn/functional.py:2976: UserWarning: reduction: 'mean' divides the total loss by both the batch size and the support size.'batchmean' divides only by the batch size, and aligns with the KL div math definition.'mean' will be changed to behave the same as 'batchmean' in the next major release.
  warnings.warn(
  3%|▎         | 13/500 [00:02<00:38, 12.52it/s, accuracy=0.797]  3%|▎         | 13/500 [00:02<00:38, 12.52it/s, accuracy=0.809]  3%|▎         | 17/500 [00:02<00:51,  9.33it/s, accuracy=0.809]  3%|▎         | 17/500 [00:02<00:51,  9.33it/s, accuracy=0.792]  3%|▎         | 17/500 [00:02<00:51,  9.33it/s, accuracy=0.803]  3%|▎         | 17/500 [00:02<00:51,  9.33it/s, accuracy=0.787]  3%|▎         | 17/500 [00:02<00:51,  9.33it/s, accuracy=0.786]  4%|▍         | 21/500 [00:02<00:38, 12.49it/s, accuracy=0.786]  4%|▍         | 21/500 [00:02<00:38, 12.49it/s, accuracy=0.784]  4%|▍         | 21/500 [00:02<00:38, 12.49it/s, accuracy=0.793]  4%|▍         | 21/500 [00:02<00:38, 12.49it/s, accuracy=0.802]  4%|▍         | 21/500 [00:02<00:38, 12.49it/s, accuracy=0.8]    5%|▌         | 25/500 [00:02<00:29, 15.86it/s, accuracy=0.8]  5%|▌         | 25/500 [00:02<00:29, 15.86it/s, accuracy=0.798]  5%|▌         | 25/500 [00:02<00:29, 15.86it/s, accuracy=0.806]  5%|▌         | 25/500 [00:02<00:29, 15.86it/s, accuracy=0.804]  5%|▌         | 25/500 [00:02<00:29, 15.86it/s, accuracy=0.793]  6%|▌         | 29/500 [00:02<00:24, 19.18it/s, accuracy=0.793]  6%|▌         | 29/500 [00:02<00:24, 19.18it/s, accuracy=0.783]  6%|▌         | 29/500 [00:02<00:24, 19.18it/s, accuracy=0.766]  6%|▌         | 29/500 [00:03<00:24, 19.18it/s, accuracy=0.766]  6%|▌         | 29/500 [00:03<00:24, 19.18it/s, accuracy=0.773]  7%|▋         | 33/500 [00:03<00:48,  9.56it/s, accuracy=0.773]  7%|▋         | 33/500 [00:03<00:48,  9.56it/s, accuracy=0.765]  7%|▋         | 33/500 [00:03<00:48,  9.56it/s, accuracy=0.771]  7%|▋         | 33/500 [00:03<00:48,  9.56it/s, accuracy=0.778]  7%|▋         | 33/500 [00:03<00:48,  9.56it/s, accuracy=0.77]   7%|▋         | 37/500 [00:03<00:37, 12.27it/s, accuracy=0.77]  7%|▋         | 37/500 [00:03<00:37, 12.27it/s, accuracy=0.77]  7%|▋         | 37/500 [00:03<00:37, 12.27it/s, accuracy=0.763]  7%|▋         | 37/500 [00:03<00:37, 12.27it/s, accuracy=0.769]  7%|▋         | 37/500 [00:03<00:37, 12.27it/s, accuracy=0.768]  8%|▊         | 41/500 [00:03<00:30, 15.15it/s, accuracy=0.768]  8%|▊         | 41/500 [00:03<00:30, 15.15it/s, accuracy=0.774]  8%|▊         | 41/500 [00:03<00:30, 15.15it/s, accuracy=0.762]  8%|▊         | 41/500 [00:03<00:30, 15.15it/s, accuracy=0.761]  8%|▊         | 41/500 [00:03<00:30, 15.15it/s, accuracy=0.767]  9%|▉         | 45/500 [00:03<00:25, 18.07it/s, accuracy=0.767]  9%|▉         | 45/500 [00:03<00:25, 18.07it/s, accuracy=0.772]  9%|▉         | 45/500 [00:03<00:25, 18.07it/s, accuracy=0.771]  9%|▉         | 45/500 [00:05<00:25, 18.07it/s, accuracy=0.766] 10%|▉         | 48/500 [00:05<01:05,  6.95it/s, accuracy=0.766] 10%|▉         | 48/500 [00:05<01:05,  6.95it/s, accuracy=0.77]  10%|▉         | 48/500 [00:05<01:05,  6.95it/s, accuracy=0.775] 10%|▉         | 48/500 [00:05<01:05,  6.95it/s, accuracy=0.775] 10%|▉         | 48/500 [00:05<01:05,  6.95it/s, accuracy=0.779] 10%|█         | 52/500 [00:05<00:48,  9.28it/s, accuracy=0.779] 10%|█         | 52/500 [00:05<00:48,  9.28it/s, accuracy=0.778] 10%|█         | 52/500 [00:05<00:48,  9.28it/s, accuracy=0.782] 10%|█         | 52/500 [00:05<00:48,  9.28it/s, accuracy=0.786] 10%|█         | 52/500 [00:05<00:48,  9.28it/s, accuracy=0.786] 11%|█         | 56/500 [00:05<00:37, 11.98it/s, accuracy=0.786] 11%|█         | 56/500 [00:05<00:37, 11.98it/s, accuracy=0.785] 11%|█         | 56/500 [00:05<00:37, 11.98it/s, accuracy=0.789] 11%|█         | 56/500 [00:05<00:37, 11.98it/s, accuracy=0.792] 11%|█         | 56/500 [00:05<00:37, 11.98it/s, accuracy=0.787] 12%|█▏        | 60/500 [00:05<00:29, 14.90it/s, accuracy=0.787] 12%|█▏        | 60/500 [00:05<00:29, 14.90it/s, accuracy=0.791] 12%|█▏        | 60/500 [00:05<00:29, 14.90it/s, accuracy=0.794] 12%|█▏        | 60/500 [00:05<00:29, 14.90it/s, accuracy=0.794] 12%|█▏        | 60/500 [00:07<00:29, 14.90it/s, accuracy=0.793] 13%|█▎        | 64/500 [00:07<01:13,  5.91it/s, accuracy=0.793] 13%|█▎        | 64/500 [00:07<01:13,  5.91it/s, accuracy=0.792] 13%|█▎        | 64/500 [00:07<01:13,  5.91it/s, accuracy=0.792] 13%|█▎        | 64/500 [00:07<01:13,  5.91it/s, accuracy=0.795] 13%|█▎        | 67/500 [00:07<00:58,  7.36it/s, accuracy=0.795] 13%|█▎        | 67/500 [00:07<00:58,  7.36it/s, accuracy=0.798] 13%|█▎        | 67/500 [00:07<00:58,  7.36it/s, accuracy=0.797] 13%|█▎        | 67/500 [00:07<00:58,  7.36it/s, accuracy=0.796] 14%|█▍        | 70/500 [00:07<00:46,  9.15it/s, accuracy=0.796] 14%|█▍        | 70/500 [00:07<00:46,  9.15it/s, accuracy=0.799] 14%|█▍        | 70/500 [00:07<00:46,  9.15it/s, accuracy=0.799] 14%|█▍        | 70/500 [00:07<00:46,  9.15it/s, accuracy=0.798] 15%|█▍        | 73/500 [00:07<00:37, 11.25it/s, accuracy=0.798] 15%|█▍        | 73/500 [00:07<00:37, 11.25it/s, accuracy=0.801] 15%|█▍        | 73/500 [00:07<00:37, 11.25it/s, accuracy=0.8]   15%|█▍        | 73/500 [00:07<00:37, 11.25it/s, accuracy=0.803] 15%|█▍        | 73/500 [00:07<00:37, 11.25it/s, accuracy=0.805] 15%|█▌        | 77/500 [00:07<00:29, 14.30it/s, accuracy=0.805] 15%|█▌        | 77/500 [00:07<00:29, 14.30it/s, accuracy=0.804] 15%|█▌        | 77/500 [00:07<00:29, 14.30it/s, accuracy=0.804] 15%|█▌        | 77/500 [00:09<00:29, 14.30it/s, accuracy=0.803] 16%|█▌        | 80/500 [00:09<01:15,  5.55it/s, accuracy=0.803] 16%|█▌        | 80/500 [00:09<01:15,  5.55it/s, accuracy=0.806] 16%|█▌        | 80/500 [00:09<01:15,  5.55it/s, accuracy=0.808] 16%|█▌        | 80/500 [00:09<01:15,  5.55it/s, accuracy=0.81]  16%|█▌        | 80/500 [00:09<01:15,  5.55it/s, accuracy=0.81] 17%|█▋        | 84/500 [00:09<00:57,  7.25it/s, accuracy=0.81] 17%|█▋        | 84/500 [00:09<00:57,  7.25it/s, accuracy=0.812] 17%|█▋        | 84/500 [00:09<00:57,  7.25it/s, accuracy=0.808] 17%|█▋        | 84/500 [00:09<00:57,  7.25it/s, accuracy=0.807] 17%|█▋        | 84/500 [00:09<00:57,  7.25it/s, accuracy=0.81]  18%|█▊        | 88/500 [00:09<00:42,  9.66it/s, accuracy=0.81] 18%|█▊        | 88/500 [00:09<00:42,  9.66it/s, accuracy=0.812] 18%|█▊        | 88/500 [00:09<00:42,  9.66it/s, accuracy=0.811] 18%|█▊        | 88/500 [00:09<00:42,  9.66it/s, accuracy=0.81]  18%|█▊        | 88/500 [00:09<00:42,  9.66it/s, accuracy=0.807] 18%|█▊        | 92/500 [00:09<00:32, 12.40it/s, accuracy=0.807] 18%|█▊        | 92/500 [00:09<00:32, 12.40it/s, accuracy=0.801] 18%|█▊        | 92/500 [00:09<00:32, 12.40it/s, accuracy=0.803] 18%|█▊        | 92/500 [00:09<00:32, 12.40it/s, accuracy=0.803] 18%|█▊        | 92/500 [00:10<00:32, 12.40it/s, accuracy=0.805] 19%|█▉        | 96/500 [00:10<01:05,  6.13it/s, accuracy=0.805] 19%|█▉        | 96/500 [00:10<01:05,  6.13it/s, accuracy=0.802] 19%|█▉        | 96/500 [00:10<01:05,  6.13it/s, accuracy=0.804] 19%|█▉        | 96/500 [00:10<01:05,  6.13it/s, accuracy=0.806] 19%|█▉        | 96/500 [00:11<01:05,  6.13it/s, accuracy=0.805] 20%|██        | 100/500 [00:11<00:51,  7.71it/s, accuracy=0.805] 20%|██        | 100/500 [00:11<00:51,  7.71it/s, accuracy=0.8]   20%|██        | 100/500 [00:11<00:51,  7.71it/s, accuracy=0.797] 20%|██        | 100/500 [00:11<00:51,  7.71it/s, accuracy=0.789] 20%|██        | 100/500 [00:11<00:51,  7.71it/s, accuracy=0.786] 21%|██        | 104/500 [00:11<00:39, 10.01it/s, accuracy=0.786] 21%|██        | 104/500 [00:11<00:39, 10.01it/s, accuracy=0.781] 21%|██        | 104/500 [00:11<00:39, 10.01it/s, accuracy=0.781] 21%|██        | 104/500 [00:11<00:39, 10.01it/s, accuracy=0.78]  21%|██        | 104/500 [00:11<00:39, 10.01it/s, accuracy=0.778] 22%|██▏       | 108/500 [00:11<00:30, 12.65it/s, accuracy=0.778] 22%|██▏       | 108/500 [00:11<00:30, 12.65it/s, accuracy=0.771] 22%|██▏       | 108/500 [00:11<00:30, 12.65it/s, accuracy=0.766] 22%|██▏       | 108/500 [00:11<00:30, 12.65it/s, accuracy=0.761] 22%|██▏       | 108/500 [00:13<00:30, 12.65it/s, accuracy=0.759] 22%|██▏       | 112/500 [00:13<01:15,  5.14it/s, accuracy=0.759] 22%|██▏       | 112/500 [00:13<01:15,  5.14it/s, accuracy=0.757] 22%|██▏       | 112/500 [00:13<01:15,  5.14it/s, accuracy=0.752] 23%|██▎       | 114/500 [00:13<01:07,  5.73it/s, accuracy=0.752] 23%|██▎       | 114/500 [00:13<01:07,  5.73it/s, accuracy=0.748] 23%|██▎       | 114/500 [00:13<01:07,  5.73it/s, accuracy=0.746] 23%|██▎       | 114/500 [00:13<01:07,  5.73it/s, accuracy=0.741] 23%|██▎       | 114/500 [00:13<01:07,  5.73it/s, accuracy=0.737] 24%|██▎       | 118/500 [00:13<00:48,  7.89it/s, accuracy=0.737] 24%|██▎       | 118/500 [00:13<00:48,  7.89it/s, accuracy=0.739] 24%|██▎       | 118/500 [00:13<00:48,  7.89it/s, accuracy=0.735] 24%|██▎       | 118/500 [00:13<00:48,  7.89it/s, accuracy=0.731] 24%|██▎       | 118/500 [00:13<00:48,  7.89it/s, accuracy=0.73]  24%|██▍       | 122/500 [00:13<00:36, 10.46it/s, accuracy=0.73] 24%|██▍       | 122/500 [00:13<00:36, 10.46it/s, accuracy=0.732] 24%|██▍       | 122/500 [00:13<00:36, 10.46it/s, accuracy=0.73]  24%|██▍       | 122/500 [00:13<00:36, 10.46it/s, accuracy=0.728] 24%|██▍       | 122/500 [00:13<00:36, 10.46it/s, accuracy=0.726] 25%|██▌       | 126/500 [00:13<00:28, 13.29it/s, accuracy=0.726] 25%|██▌       | 126/500 [00:13<00:28, 13.29it/s, accuracy=0.724] 25%|██▌       | 126/500 [00:15<00:28, 13.29it/s, accuracy=0.725] 25%|██▌       | 126/500 [00:15<00:28, 13.29it/s, accuracy=0.721] 26%|██▌       | 129/500 [00:15<01:20,  4.59it/s, accuracy=0.721] 26%|██▌       | 129/500 [00:15<01:20,  4.59it/s, accuracy=0.719] 26%|██▌       | 129/500 [00:15<01:20,  4.59it/s, accuracy=0.718] 26%|██▌       | 131/500 [00:15<01:08,  5.37it/s, accuracy=0.718] 26%|██▌       | 131/500 [00:15<01:08,  5.37it/s, accuracy=0.718] 26%|██▌       | 131/500 [00:15<01:08,  5.37it/s, accuracy=0.716] 26%|██▌       | 131/500 [00:15<01:08,  5.37it/s, accuracy=0.716] 27%|██▋       | 134/500 [00:15<00:51,  7.04it/s, accuracy=0.716] 27%|██▋       | 134/500 [00:15<00:51,  7.04it/s, accuracy=0.713] 27%|██▋       | 134/500 [00:15<00:51,  7.04it/s, accuracy=0.711] 27%|██▋       | 134/500 [00:15<00:51,  7.04it/s, accuracy=0.71]  27%|██▋       | 137/500 [00:15<00:40,  9.07it/s, accuracy=0.71] 27%|██▋       | 137/500 [00:16<00:40,  9.07it/s, accuracy=0.705] 27%|██▋       | 137/500 [00:16<00:40,  9.07it/s, accuracy=0.703] 27%|██▋       | 137/500 [00:16<00:40,  9.07it/s, accuracy=0.702] 28%|██▊       | 140/500 [00:16<00:31, 11.39it/s, accuracy=0.702] 28%|██▊       | 140/500 [00:16<00:31, 11.39it/s, accuracy=0.7]   28%|██▊       | 140/500 [00:16<00:31, 11.39it/s, accuracy=0.699] 28%|██▊       | 140/500 [00:16<00:31, 11.39it/s, accuracy=0.698] 29%|██▊       | 143/500 [00:16<00:25, 13.84it/s, accuracy=0.698] 29%|██▊       | 143/500 [00:16<00:41,  8.57it/s, accuracy=0.698]
Traceback (most recent call last):
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/main.py", line 57, in <module>
    main()
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/main.py", line 54, in main
    testTimeAdaptation(student, teacher, dataset_dir, attack)
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/main.py", line 41, in testTimeAdaptation
    evaluate_tta(loader, tta_model, 'RoTTA+ADaaD2', attack_type)
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/helper.py", line 73, in evaluate_tta
    output = tta_model(images)
             ^^^^^^^^^^^^^^^^^
  File "/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/base_adapter.py", line 22, in forward
    outputs = self.forward_and_adapt(x, self.model, self.optimizer)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/utils/_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/rotta.py", line 40, in forward_and_adapt
    self.update_model(model, optimizer)
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/rotta.py", line 47, in update_model
    x_adv = self.adaad_inner_loss(student, self.teacher, x_nat, self.attack)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/rotta.py", line 83, in adaad_inner_loss
    return fgsm_kl(model, teacher_model, x_natural, epsilon, BN_eval, random_init, clip_min, clip_max)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/Documents/RoTTA Enhancement/RoTTA/AT.py", line 28, in fgsm_kl
    grad = torch.autograd.grad(loss_kl, [x_adv])[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/autograd/__init__.py", line 412, in grad
    result = _engine_run_backward(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/home/project/miniconda3/envs/tta/lib/python3.12/site-packages/torch/autograd/graph.py", line 744, in _engine_run_backward
    return Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 40.00 MiB. GPU 
